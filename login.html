<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grencz's Grinch Points Math Game Login</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
  // AUTO-LOGIN BYPASS LOGIC -- runs instantly
  const storedName = localStorage.getItem('mathgame_lastname');
  const storedHour = localStorage.getItem('mathgame_hour');

  if (storedName && storedHour) {
    const dayNum = (new Date()).getDay();
    const gameTypeArray = ["addition","subtraction","multiplication","division","exponents"];

    if (dayNum >= 1 && dayNum <= 5) {
      // Weekdays: assign corresponding game type (Monday=1 is addition, ... Friday=5 is exponents)
      const gameType = gameTypeArray[dayNum - 1];
      window.location.href = "index_new.html?lastname=" + encodeURIComponent(storedName)
        + "&hour=" + storedHour
        + "&game=" + gameType;
    } else {
      // Weekend (Sunday=0, Saturday=6): go to points screen
      window.location.href = "points.html?lastname=" + encodeURIComponent(storedName)
        + "&hour=" + storedHour;
    }
  }
</script>

</head>
<body>
  <div id="login-box">
    <h2 style="color: #05B25A;">Sign In</h2>
    <input id="lastname" type="text" maxlength="20" placeholder="Last Name">
    <select id="hour">
      <option value="">Select Hour</option>
      <option value="01">Hour 01</option>
      <option value="02">Hour 02</option>
      <option value="03">Hour 03</option>
      <option value="04">Hour 04</option>
      <option value="05">Hour 05</option>
      <option value="06">Hour 06</option>
      <option value="07">Hour 07</option>
      <option value="00">Guest</option>
    </select>
    <div id="login-error"></div>
    <button id="login-btn">Log In</button>
  </div>

  <!-- Only ONE module script! -->
  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js@2.38.5";
    const SUPABASE_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDMwOTMsImV4cCI6MjA3ODQ3OTA5M30.h-WabaGcQZ968sO2ImetccUaRihRFmO2mUKCdPiAbEI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById("login-btn").onclick = async function() {
      var lastname = document.getElementById("lastname").value.trim();
      var hour = document.getElementById("hour").value;
      var errBox = document.getElementById("login-error");
      errBox.textContent = '';

      // Validate
      if (lastname.length < 2 || !/^[a-zA-Z\-\' ]+$/.test(lastname)) {
        errBox.textContent = "Please enter your last name.";
        return;
        }
      if (!/^0[0-7]$/.test(hour)) {
        errBox.textContent = "Please select your hour (01-07 or Guest).";
        return;
        }

      // For guest hour ("00"), allow all names
      if (hour !== "00") {
      // Must exist for this name+hour
      const { data, error } = await supabase
        .from('scores')
        .select('id')
        .ilike('lastname', lastname)
        .eq('hour', hour);

      if (error) {
        errBox.textContent = "Cannot check name right now. Try again later.";
        console.error(error);
        return;
        }
      if (!data || data.length === 0) {
        errBox.textContent = "Name not found for your selected hour. Please check your spelling or ask your teacher.";
        return;
        }
      }

  // Proceed with normal login...
  var gameTypeArray = ["addition","subtraction","multiplication","division","exponents"];
var dayNum = (new Date()).getDay();
var nextURL;
if (dayNum >= 1 && dayNum <= 5) {
  var gameType = gameTypeArray[dayNum - 1];
  nextURL = "index_new.html?lastname=" + encodeURIComponent(lastname)
    + "&hour=" + hour
    + "&game=" + gameType;
} else {
  // Weekend (Sunday=0, Saturday=6)
  nextURL = "points.html?lastname=" + encodeURIComponent(lastname)
    + "&hour=" + hour;
}

localStorage.setItem('mathgame_lastname', lastname);
localStorage.setItem('mathgame_hour', hour);

window.location.href = nextURL;
};

    // Enter key triggers login
    document.getElementById("hour").addEventListener('keydown', function(e){
      if(e.key === "Enter") document.getElementById("login-btn").click();
    });
    document.getElementById("lastname").addEventListener('keydown', function(e){
      if(e.key === "Enter") document.getElementById("hour").focus();
    });
  </script>

</body>
</html>
