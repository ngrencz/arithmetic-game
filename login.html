<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grencz's Grinch Points Math Game Login</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="login-box">
    <h2 style="color: #05B25A;">Sign In</h2>
    <label for="lastname">Last Name:</label>
    <input id="lastname" type="text" maxlength="20" placeholder="Last Name" autocomplete="family-name">

    <label for="hour">Hour:</label>
    <select id="hour">
      <option value="">Select Hour</option>
      <option value="01">Hour 01</option>
      <option value="02">Hour 02</option>
      <option value="03">Hour 03</option>
      <option value="04">Hour 04</option>
      <option value="05">Hour 05</option>
      <option value="06">Hour 06</option>
      <option value="07">Hour 07</option>
      <option value="00">Guest</option>
    </select>
    <div id="login-error" style="color:red;"></div>
    <button id="login-btn">Log In</button>
  </div>

  <script type="module">
    <script type="module">
  import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js@2.38.5";
  const SUPABASE_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDMwOTMsImV4cCI6MjA3ODQ3OTA5M30.h-WabaGcQZ968sO2ImetccUaRihRFmO2mUKCdPiAbEI";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  function redirectForDay(lastname, hour) {
    const dayNum = (new Date()).getDay();
    const gameTypeArray = ["addition", "subtraction", "multiplication", "division", "exponents"];
    const page = (dayNum >= 1 && dayNum <= 5) ? "index.html" : "points.html";
    let url = `${page}?lastname=${encodeURIComponent(lastname)}&hour=${hour}`;
    if (dayNum >= 1 && dayNum <= 5) url += `&game=${gameTypeArray[dayNum - 1]}`;
    window.location.href = url;
  }

  document.getElementById("login-btn").onclick = async function() {
    const inputVal = document.getElementById("lastname").value.trim();
    const hour = document.getElementById("hour").value;
    const errBox = document.getElementById("login-error");
    errBox.textContent = '';

    if (!inputVal || !hour) {
      errBox.textContent = "Please enter your name/username and select an hour.";
      return;
    }

    // 1. TRY LOGGING IN AS USERNAME (Lowercase check)
    const { data: userCheck } = await supabase.from('scores').select('id').eq('lastname', inputVal.toLowerCase()).eq('hour', hour);

    if (userCheck && userCheck.length > 0) {
      localStorage.setItem('mathgame_lastname', inputVal.toLowerCase());
      localStorage.setItem('mathgame_hour', hour);
      redirectForDay(inputVal.toLowerCase(), hour);
      return;
    }

    // 2. FALLBACK: CHECK FOR OLD LAST NAME (Case Sensitive)
    const { data: nameCheck } = await supabase.from('scores').select('id').eq('lastname', inputVal).eq('hour', hour);

    if (nameCheck && nameCheck.length > 0) {
      // It's an old name! Ask for a username
      const newU = prompt(`Welcome back, ${inputVal}! For privacy, please pick a nickname (no part of your real name):`);
      
      if (!newU || newU.length < 3 || newU.toLowerCase().includes(inputVal.toLowerCase())) {
        alert("Invalid username. Must be 3+ letters and not include your last name.");
        return;
      }

      // Check if the nickname is taken
      const { data: taken } = await supabase.from('scores').select('id').eq('lastname', newU.toLowerCase()).limit(1);
      if (taken && taken.length > 0) {
        alert("That nickname is already taken!");
        return;
      }

      // UPDATE ALL RECORDS IN SUPABASE
      const { error } = await supabase.from('scores').update({ lastname: newU.toLowerCase() }).eq('lastname', inputVal).eq('hour', hour);

      if (!error) {
        localStorage.setItem('mathgame_lastname', newU.toLowerCase());
        localStorage.setItem('mathgame_hour', hour);
        redirectForDay(newU.toLowerCase(), hour);
      } else {
        errBox.textContent = "Error saving. Try again.";
      }
    } else {
      errBox.textContent = "Record not found. Check spelling and hour.";
    }
  };

  // Keep your Enter key listeners
  document.getElementById("hour").addEventListener('keydown', (e) => { if(e.key === "Enter") document.getElementById("login-btn").click(); });
  document.getElementById("lastname").addEventListener('keydown', (e) => { if(e.key === "Enter") document.getElementById("hour").focus(); });
</script>
  </script>
</body>
</html>
