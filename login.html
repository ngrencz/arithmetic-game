<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grencz's Grinch Points Math Game Login</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="login-box">
    <h2 style="color: #05B25A;">Sign In</h2>
    <label for="lastname">Last Name:</label>
    <input id="lastname" type="text" maxlength="20" placeholder="Last Name" autocomplete="family-name">

    <label for="hour">Hour:</label>
    <select id="hour">
      <option value="">Select Hour</option>
      <option value="01">Hour 01</option>
      <option value="02">Hour 02</option>
      <option value="03">Hour 03</option>
      <option value="04">Hour 04</option>
      <option value="05">Hour 05</option>
      <option value="06">Hour 06</option>
      <option value="07">Hour 07</option>
      <option value="00">Guest</option>
    </select>
    <div id="login-error" style="color:red;"></div>
    <button id="login-btn">Log In</button>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js@2.38.5";
    const SUPABASE_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDMwOTMsImV4cCI6MjA3ODQ3OTA5M30.h-WabaGcQZ968sO2ImetccUaRihRFmO2mUKCdPiAbEI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    function redirectForDay(user, hour) {
      const dayNum = (new Date()).getDay();
      const gameTypeArray = ["addition", "subtraction", "multiplication", "division", "exponents"];
      const target = (dayNum >= 1 && dayNum <= 5) ? "index.html" : "points.html";
      let url = `${target}?lastname=${encodeURIComponent(user)}&hour=${hour}`;
      if (dayNum >= 1 && dayNum <= 5) url += `&game=${gameTypeArray[dayNum - 1]}`;
      window.location.href = url;
    }

    function loginUser(name, hour) {
      localStorage.setItem('mathgame_lastname', name);
      localStorage.setItem('mathgame_hour', hour);
      redirectForDay(name, hour);
    }

    document.getElementById("login-btn").onclick = async function() {
      const rawInput = document.getElementById("lastname").value.trim();
      const hour = document.getElementById("hour").value;
      const errBox = document.getElementById("login-error");
      errBox.textContent = '';

      if (!rawInput || !hour) {
        errBox.textContent = "Enter your name/nickname and select an hour.";
        return;
      }

      // 1. Force Title Case for the first search (e.g., "grencz" -> "Grencz")
      const titleCaseName = rawInput.charAt(0).toUpperCase() + rawInput.slice(1).toLowerCase();
      
      // 2. SEARCH 1: Check for Title Case (Trigger for nickname prompt)
      const { data: titleCheck } = await supabase
          .from('scores')
          .select('lastname')
          .eq('lastname', titleCaseName)
          .eq('hour', hour);

      if (titleCheck && titleCheck.length > 0) {
          const newNickname = prompt(`Welcome, ${titleCaseName}! Please create a nickname (3+ letters, lowercase, no real names):`);
          
          if (!newNickname || newNickname.trim().length < 3) {
              alert("Nickname too short! Try again.");
              return;
          }

          const cleanNick = newNickname.trim().toLowerCase();

          // Update all records for this student to their new nickname
          const { error: updateErr } = await supabase
              .from('scores')
              .update({ lastname: cleanNick })
              .eq('lastname', titleCaseName)
              .eq('hour', hour);

          if (!updateErr) {
              loginUser(cleanNick, hour);
          } else {
              errBox.textContent = "Error saving nickname.";
          }
          return; 
      }

      // 3. SEARCH 2: Check for Lowercase (Standard login for existing nicknames)
      const { data: nickCheck } = await supabase
          .from('scores')
          .select('lastname')
          .eq('lastname', rawInput.toLowerCase())
          .eq('hour', hour);

      if (nickCheck && nickCheck.length > 0) {
          loginUser(rawInput.toLowerCase(), hour);
      } else {
          errBox.textContent = "Name not found. Use your Last Name (Capitalized) for your first login.";
      }
    };

    // ENTER KEY SUPPORT
    document.getElementById("lastname").addEventListener('keydown', (e) => {
      if (e.key === "Enter") document.getElementById("hour").focus();
    });
    document.getElementById("hour").addEventListener('keydown', (e) => {
      if (e.key === "Enter") document.getElementById("login-btn").click();
    });
  </script>
</body>
</html>
