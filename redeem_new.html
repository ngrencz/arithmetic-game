<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Points Redemption Table</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Title Bubble -->
  <div class="card-box" style="font-size:2em; font-weight:bold; color:#03793A; margin-top:2.2em; margin-bottom:0.4em;">
    Live Points Redemption Board
  </div>

  <!-- Redemption Form Bubble -->
  <div class="card-box" id="redeem-box">
    <form class="form-inline" onsubmit="return false;">
      <label for="hour-select">Hour:</label>
      <select id="hour-select">
        <option value="">Select Hour</option>
        <option value="00">Hour 00</option>
        <option value="01">Hour 01</option>
        <option value="02">Hour 02</option>
        <option value="03">Hour 03</option>
        <option value="04">Hour 04</option>
        <option value="05">Hour 05</option>
        <option value="06">Hour 06</option>
        <option value="07">Hour 07</option>
      </select>

      <label for="name-select">Name:</label>
      <select id="name-select">
        <option value="">Select Name</option>
      </select>
      <br>
      <span id="points-available" style="font-weight:bold; margin-left:10px;"></span>

      <label for="redeem-points" style="margin-left:10px;">Points to Deduct:</label>
      <input type="number" id="redeem-points" value="1" min="1" style="width:50px;" />

      <button id="redeem-submit">Redeem Points</button>
      <span id="redeem-message" style="color:green; margin-left:10px;"></span>
    </form>
    <div class="redeem-caption" style="margin-top:0.9em;">
      Redeem this many points for prizes
    </div>
  </div>

  <!-- Leaderboard Bubble -->
  <div class="card-box" id="leaderboard-window" style="padding-top:0.6em;">
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>Last Name</th>
          <th>Hour</th>
          <th>Points Redeemed</th>
          <th>Redeemed At</th>
        </tr>
      </thead>
      <tbody id="redemption-list"></tbody>
    </table>
  </div>

  <!-- Include your working JS exactly as before -->
  
  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js@2.38.5";

    const SUPABASE_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDMwOTMsImV4cCI6MjA3ODQ3OTA5M30.h-WabaGcQZ968sO2ImetccUaRihRFmO2mUKCdPiAbEI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Fetch names and points for the selected hour ---
    async function fetchNamesAndPointsForHour(hour) {
      if (!hour) return [];
      const { data, error } = await supabase
        .from('scores')
        .select('lastname, hour, points')
        .eq('hour', hour)
        .neq('lastname', ''); // Do not filter by game_type

      if (error) {
        console.error(error);
        return [];
  }

  // Aggregate: sum all points for each username, including negative (redeem) and positive (earn)
  const pointsByName = {};
  data.forEach(row => {
    pointsByName[row.lastname] = (pointsByName[row.lastname] || 0) + (row.points || 0);
  });

  // Return as array for dropdown use
  return Object.entries(pointsByName).map(([lastname, points]) => ({ lastname, points }));
}

    // --- Update Name Dropdown and Points Map ---
    async function updateNameDropdown() {
      const hour = document.getElementById("hour-select").value;
      const nameSelect = document.getElementById("name-select");
      nameSelect.innerHTML = '<option value="">Select Name</option>';
      document.getElementById('points-available').textContent = '';
      if (!hour) return;
      const allNamesAndPoints = await fetchNamesAndPointsForHour(hour);
      allNamesAndPoints.forEach(({ lastname }) => {
        const opt = document.createElement('option');
        opt.value = lastname;
        opt.textContent = lastname;
        nameSelect.appendChild(opt);
      });
      // Store all available points for later lookup on select
      nameSelect._pointsMap = Object.fromEntries(allNamesAndPoints.map(np => [np.lastname, np.points]));
    }

    document.getElementById("hour-select").addEventListener("change", updateNameDropdown);

    // --- Show Available Points When Name Selected ---
    document.getElementById("name-select").addEventListener("change", function() {
      const name = this.value;
      const pointsMap = this._pointsMap || {};
      const pts = pointsMap[name] ?? 0;
      document.getElementById('points-available').textContent =
        name ? (`Available Points: ${pts}`) : "";
    });

    // --- Submit Redemption Event ---
    document.getElementById("redeem-submit").addEventListener("click", async () => {
      const hour = document.getElementById("hour-select").value;
      const lastname = document.getElementById("name-select").value;
      const pointsRaw = parseInt(document.getElementById("redeem-points").value, 10);
      const messageSpan = document.getElementById("redeem-message");
      messageSpan.textContent = '';

      if (!hour || !lastname || isNaN(pointsRaw) || pointsRaw <= 0) {
        messageSpan.style.color = 'red';
        messageSpan.textContent = "Please fill out all fields correctly!";
        return;
      }
      const points = -Math.abs(pointsRaw); // Always negative

      // Insert redemption row into Supabase
      const { data, error } = await supabase
        .from('scores')
        .insert([{
          lastname,
          hour,
          points,
          game_type: "redeem",
          score: 0,
          created_at: new Date().toISOString()
        }]);

      if (error) {
        console.error(error);
        messageSpan.style.color = 'red';
        messageSpan.textContent = "Error redeeming points!";
        return;
      }
      messageSpan.style.color = 'green';
      messageSpan.textContent = "Points redeemed!";

      // Optionally reset to defaults
      document.getElementById("redeem-points").value = "1";
      setTimeout(() => { messageSpan.textContent = ''; }, 2000);

      updateBoard(); // refresh the tableawait updateNameDropdown();
        await updateNameDropdown();
        // If currently-selected name, reset points displayed for it:
        const nameSelect = document.getElementById("name-select");
        const name = nameSelect.value;
        const pointsMap = nameSelect._pointsMap || {};
        const pts = pointsMap[name] ?? 0;
        document.getElementById('points-available').textContent =
          name ? (`Available Points: ${pts}`) : "";
    });

    // --- Table code ---
    async function fetchRedemptions() {
      const { data, error } = await supabase
        .from('scores')
        .select('lastname, hour, points, created_at')
        .eq('game_type', 'redeem')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        return [];
      }
      return data;
    }

    function renderTable(redemptions) {
      const tbody = document.getElementById('redemption-list');
      tbody.innerHTML = '';
      redemptions.forEach(({ lastname, hour, points, created_at }) => {
        const localTime = created_at
          ? new Date(created_at).toLocaleString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          })
        : "";
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${lastname}</td>
          <td>${hour}</td>
          <td>${points}</td>
          <td>${localTime}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateBoard() {
      const data = await fetchRedemptions();
      renderTable(data);
    }
    setInterval(updateBoard, 5000);
    updateBoard();

    // Realtime subscription for instant updates
    const channel = supabase.channel('scores-redeem');
    channel
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'scores',
        filter: 'game_type=eq.redeem'
      }, payload => {
        updateBoard();
      })
      .subscribe();
  </script>
</body>
</html>
