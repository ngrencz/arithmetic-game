<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Points Redemption Table</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Title Bubble -->
  <div class="card-box" style="font-size:2em; font-weight:bold; color:#03793A; margin-top:2.2em; margin-bottom:0.4em;">
    Live Points Redemption Board
  </div>

  <!-- Redemption Form Bubble -->
  <div class="card-box" id="redeem-box">
    <form class="form-inline" onsubmit="return false;">
      <label for="hour-select">Hour:</label>
      <select id="hour-select">
        <option value="">Select Hour</option>
        <option value="00">Hour 00</option>
        <option value="01">Hour 01</option>
        <option value="02">Hour 02</option>
        <option value="03">Hour 03</option>
        <option value="04">Hour 04</option>
        <option value="05">Hour 05</option>
        <option value="06">Hour 06</option>
        <option value="07">Hour 07</option>
      </select>

      <label for="name-select">Name:</label>
      <select id="name-select">
        <option value="">Select Name</option>
      </select>

      <span id="points-available" style="font-weight:bold; margin-left:10px;"></span>

      <label for="redeem-points" style="margin-left:10px;">Points to Deduct:</label>
      <input type="number" id="redeem-points" value="1" min="1" style="width:50px;" />

      <button id="redeem-submit">Redeem Points</button>
      <span id="redeem-message" style="color:green; margin-left:10px;"></span>
    </form>
    <div class="redeem-caption" style="margin-top:0.9em;">
      Redeem this many points for prizes
    </div>
  </div>

  <!-- Leaderboard Bubble -->
  <div class="card-box" id="leaderboard-window" style="padding-top:0.6em;">
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>Last Name</th>
          <th>Hour</th>
          <th>Points Redeemed</th>
          <th>Redeemed At</th>
        </tr>
      </thead>
      <tbody id="redemption-list"></tbody>
    </table>
  </div>

  <!-- Include your working JS exactly as before -->
  
  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js@2.38.5";

    const SUPABASE_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDMwOTMsImV4cCI6MjA3ODQ3OTA5M30.h-WabaGcQZ968sO2ImetccUaRihRFmO2mUKCdPiAbEI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    async function fetchRedemptions() {
      // Fetch only records where game_type = 'redeem'
      const { data, error } = await supabase
        .from('scores') // your table name
        .select('lastname, hour, points, created_at')
        .eq('game_type', 'redeem')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        return [];
      }
      return data;
    }

    function renderTable(redemptions) {
      const tbody = document.getElementById('redemption-list');
      tbody.innerHTML = '';
      redemptions.forEach(({ lastname, hour, points, created_at }) => {
        const localTime = created_at ? new Date(created_at).toLocaleString() : "";
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${lastname}</td>
          <td>${hour}</td>
          <td>${points}</td>
          <td>${localTime}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateBoard() {
      const data = await fetchRedemptions();
      renderTable(data);
    }

    // Run every 5s as a fallback (optional)
    setInterval(updateBoard, 5000);
    // Run once immediately on load
    updateBoard();

    // Realtime Supabase subscription updates
    const channel = supabase.channel('scores-redeem');
    channel
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'scores',
        filter: 'game_type=eq.redeem'
      }, payload => {
        updateBoard();
      })
      .subscribe();
  </script>
</body>
</html>
