<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grencz's Grinch Points Math Game Login</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="login-box">
    <h2 style="color: #05B25A;">Sign In</h2>
    <label for="lastname">Last Name:</label>
    <input id="lastname" type="text" maxlength="20" placeholder="Last Name" autocomplete="family-name">

    <label for="hour">Hour:</label>
    <select id="hour">
      <option value="">Select Hour</option>
      <option value="01">Hour 01</option>
      <option value="02">Hour 02</option>
      <option value="03">Hour 03</option>
      <option value="04">Hour 04</option>
      <option value="05">Hour 05</option>
      <option value="06">Hour 06</option>
      <option value="07">Hour 07</option>
      <option value="00">Guest</option>
    </select>
    <div id="login-error" style="color:red;"></div>
    <button id="login-btn">Log In</button>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js@2.38.5";
    const SUPABASE_URL = "https://khazeoycsjdqnmwodncw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoYXplb3ljc2pkcW5td29kbmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDMwOTMsImV4cCI6MjA3ODQ3OTA5M30.h-WabaGcQZ968sO2ImetccUaRihRFmO2mUKCdPiAbEI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Helper function to handle redirects
    function redirectForDay(lastname, hour) {
      const dayNum = (new Date()).getDay();
      const gameTypeArray = ["addition", "subtraction", "multiplication", "division", "exponents"];
      if (dayNum >= 1 && dayNum <= 5) {
        const gameType = gameTypeArray[dayNum - 1];
        window.location.href =
          "index_new.html?lastname=" + encodeURIComponent(lastname)
          + "&hour=" + hour
          + "&game=" + gameType;
      } else {
        window.location.href =
          "points.html?lastname=" + encodeURIComponent(lastname)
          + "&hour=" + hour;
      }
    }

    // AUTO-LOGIN (no exceptions; ALL login types checked against Supabase)
    async function autoLoginCheck() {
      const storedName = localStorage.getItem('mathgame_lastname');
      const storedHour = localStorage.getItem('mathgame_hour');
      if (storedName && storedHour) {
        const { data, error } = await supabase
          .from('scores')
          .select('id')
          .eq('lastname', storedName)
          .eq('hour', storedHour);

        if (error) {
          console.error("Supabase error during auto-login:", error);
          return;
        }
        if (data && data.length > 0) {
          redirectForDay(storedName, storedHour);
        } else {
          localStorage.removeItem('mathgame_lastname');
          localStorage.removeItem('mathgame_hour');
          // They remain on login page
        }
      }
    }

    autoLoginCheck();

    // MANUAL LOGIN
    document.getElementById("login-btn").onclick = async function() {
      var lastname = document.getElementById("lastname").value.trim();
      var hour = document.getElementById("hour").value;
      var errBox = document.getElementById("login-error");
      errBox.textContent = '';

      // Validate
      if (lastname.length < 2 || !/^[a-zA-Z\-\' ]+$/.test(lastname)) {
        errBox.textContent = "Please enter your last name.";
        return;
      }
      if (!/^0[0-7]$/.test(hour)) {
        errBox.textContent = "Please select your hour (01-07 or Guest).";
        return;
      }

      // Must exist for this name+hour (NO guest bypass)
      const { data, error } = await supabase
        .from('scores')
        .select('id')
        .eq('lastname', lastname)
        .eq('hour', hour);

      if (error) {
        errBox.textContent = "Cannot check name right now. Try again later.";
        console.error(error);
        return;
      }
      if (!data || data.length === 0) {
        errBox.textContent = "Name not found for your selected hour. Please check your spelling or ask your teacher.";
        return;
      }

      // Save to localStorage for auto-login next time
      localStorage.setItem('mathgame_lastname', lastname);
      localStorage.setItem('mathgame_hour', hour);

      redirectForDay(lastname, hour);
    };

    // Enter key triggers login
    document.getElementById("hour").addEventListener('keydown', function(e){
      if(e.key === "Enter") document.getElementById("login-btn").click();
    });
    document.getElementById("lastname").addEventListener('keydown', function(e){
      if(e.key === "Enter") document.getElementById("hour").focus();
    });
  </script>
</body>
</html>
